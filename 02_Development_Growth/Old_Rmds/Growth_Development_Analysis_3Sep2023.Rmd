---
title: "Growth rate analysis_5May2020_UPDATED"
author: "Carolyn Cummins"
date: "5/5/2020"
output: html_document
---
This Rmd file contains the data carpentry and analysis for growth and development rate data from the streamside channels experiment. 

*This script contains only instantaneous growth rate calculations -- IGR = ln(final)-ln(initial)/days (Huryn & Benke 1986, Hauer & Benke 1991, Reynolds & Benke 2005)

```{r}

library(Rmisc)
library(lme4)
library(lmerTest)
library(ggplot2)
library(tidyverse)
photos.beg.all<-read.csv("SSC2019.photos.beg.csv")
photos.end.all<-read.csv("SSC2019.photos.end.csv")

```


Merge beginning and ending data, process
```{r}

merged.photos.all<-merge(photos.beg.all,photos.end.all,by=c("Chamber", "Channel", "Temp.TRT", "Leaf.spp."))

merged.photos.all<-merged.photos.all[-c(11:17, 23:29)]

colnames(merged.photos.all)[colnames(merged.photos.all)=="Notes.x"] <- "Notes.beg"

colnames(merged.photos.all)[colnames(merged.photos.all)=="Notes.y"] <- "Notes.end"

```


Add in estimated masses using DM=aL^b (Benke et al. 1999)
```{r}

merged.photos.all$beg.mass.mg<-((merged.photos.all$Beg.Length.mm^2.737)*(0.0170))

merged.photos.all$end.mass.mg<-((merged.photos.all$End.Length.mm^2.737)*(0.0170))

merged.photos.all$igr<-(((log(merged.photos.all$end.mass.mg))-(log(merged.photos.all$beg.mass.mg)))/(merged.photos.all$Days.in.expt))

hist.length <- hist(merged.photos.all$Beg.Length.mm)
hist.mass <- hist(merged.photos.all$beg.mass.mg)

```


#determining outliers -- 2 sds above or below the mean!
```{r}

#standard deviation method (outliers are those observations that lie outside 2 sds from the mean)
mean.igr.all<-mean(merged.photos.all$igr)

twosd.igr.all<-2*sd(merged.photos.all$igr)

UL.igr.all<-mean.igr.all+twosd.igr.all

LL.igr.all<-mean.igr.all-twosd.igr.all

```


#processing and subsetting - exclude outliers, then make separate dataframes for Rhodo and Acer
```{r}

merged.photos.all2<-merged.photos.all[which(merged.photos.all$igr<UL.igr.all),]

merged.photos.all3<-merged.photos.all2[which(merged.photos.all2$igr>LL.igr.all),]

merged.photos.allR<-merged.photos.all3[which(merged.photos.all3$Leaf.spp.=="Rhodo"),]

merged.photos.allA<-merged.photos.all3[which(merged.photos.all3$Leaf.spp.=="Acer"),]
#excluded a total of 9 outliers from the whole dataset.

```


Summary by channel
```{r}

summSE.bychannel.igr<-summarySE(merged.photos.all3,measurevar="igr",groupvars=c("Channel","Leaf.spp.", "Temp.TRT"),na.rm=TRUE)
#produces NA's for Rhodo 4A because there was only one bug in that channel at the end of the experiment.

summSE.bychannel.igr$Temp.TRT<-as.numeric(summSE.bychannel.igr$Temp.TRT)

summ.SE.bychannel.R.igr<-summSE.bychannel.igr[which(summSE.bychannel.igr$Leaf.spp.=="Rhodo"),]

summ.SE.bychannel.A.igr<-summSE.bychannel.igr[which(summSE.bychannel.igr$Leaf.spp.=="Acer"),]

```


Summary by treatment
```{r}

summSE.bytrt.igr <- summarySE(merged.photos.all3, measurevar = "igr", groupvars=c("Temp.TRT", "Leaf.spp."), na.rm=TRUE)

```


Graphs based on raw means by trt (mean is mean igr of all bugs across all channels)
```{r}

barplot.2.byspp <- ggplot(summSE.bytrt.igr, aes(x=Temp.TRT, y=igr, group=Leaf.spp., color=Leaf.spp.))+
   theme_classic()+
   geom_bar(aes(fill = Leaf.spp.), width = 0.4, position = position_dodge(width=0.5), stat="identity")+  
   theme(legend.position="right", legend.title=element_blank())+
   geom_errorbar(aes(ymin=igr-se,ymax=igr+se), width=.2, position=position_dodge(width=0.5))+
   scale_fill_manual(values=c("#F7E225FF", "#3F4788FF"),
                     labels=c(expression(paste(italic("Acer"))),expression(paste(italic("Rhododendron")))))+
   scale_color_manual(values=c("black","black"), guide="none")+
   xlab("Temperature treatment")+
   ylab(expression(atop(paste("Instantaneous Growth Rate"), "(mg d"^-1*")")))+
  theme(legend.text=element_text(size=14))+
  theme(axis.title=element_text(size=14))+
  theme(axis.text=element_text(size=12, face="bold"))+
   scale_x_continuous(breaks=0:4, labels=c("+0°C","+1°C","+2°C","+3°C","+4°C"))+
  theme(legend.text.align=0)
  
barplot.2.byspp

```


```{r}

scatterplot.2.byspp<-ggplot(summSE.bytrt.igr, aes(x=Temp.TRT, y=igr, group=Leaf.spp., color=Leaf.spp.))+
   theme_classic()+
   geom_point(position=position_dodge(width=0.5))+  
   theme(legend.position = "right", legend.title = element_blank())+
   xlab("Temperature treatment")+
   ylab(expression(atop(paste("Instantaneous Growth Rate"), "(mg d"^-1*")")))+
   geom_errorbar(aes(ymin=igr-se, ymax=igr+se), width=.2,position=position_dodge(width=0.5))+
   scale_color_manual(values=c("#FEB72DFF", "#3F4788FF"),
                      labels=c(expression(paste(italic("Acer"))),expression(paste(italic("Rhododendron")))))+
  theme(legend.text=element_text(size=14))+
  theme(axis.title=element_text(size=14))+
  theme(axis.text=element_text(size=12, face="bold"))+
   scale_x_continuous(breaks=0:4, labels=c("+0°C","+1°C","+2°C","+3°C","+4°C"))+
   geom_smooth(method="lm", data=merged.photos.allA)+
   theme(axis.text=element_text(size=14))+
   theme(axis.title=element_text(size=18))+
   theme(legend.text=element_text(size=14))+
  theme(legend.text.align=0)

scatterplot.2.byspp

```


lmer models
```{r}
#Rhodo data only - does temperature have an effect on igr for bugs fed Rhodo?
model2.Rhodo.igr.data <- lmer(igr ~ Temp.TRT + (1|Channel), data=merged.photos.allR)
summary(model2.Rhodo.igr.data)

#Acer data only - does temperature have an effect on igr for bugs fed Acer?
model3.Acer.igr.data <- lmer(igr ~ Temp.TRT + (1|Channel), data=merged.photos.allA)
summary(model3.Acer.igr.data)

#Does the effect of temperature on igr depend on leaf species?
model4.all.int.igr.bylfsp <- lmer(igr ~ Temp.TRT*Leaf.spp. + (1|Channel), data=merged.photos.all3)
summary(model4.all.int.igr.bylfsp)

```


lmer models - additional exploration
```{r}

#all the data - does temperature have an effect on igr overall (both leaf species)
model1.all.data.igr <- lmer(igr ~ Temp.TRT + (1|Channel), data=merged.photos.all3)
summary(model1.all.data.igr)
#yes - marginally significant

#Is the effect of temperature on igr quadratic for Rhodo?
lm.all.Rquad.sp.igr <- lmer(igr ~ Temp.TRT+I(Temp.TRT^2) + (1|Channel), data=merged.photos.allR)
summary(lm.all.Rquad.sp.igr)
#no

```


```{r}
jpeg(filename="scatterplot.growth.jpeg", width=20, height=12, units="cm", pointsize=12, bg="white", res=600)
scatterplot.2.byspp
dev.off()
```


#####


Development rate analysis

Read in the development rate data
```{r}

BWP<-read.csv("SSC2019_BWP_3Sept2023.csv")
BWP$prop.BWP<-BWP$BWP/BWP$bugs.rem

```


How many bugs in each treatment at the end of the experiment?
```{r}

BWP_4 <- BWP %>% filter(Temp.TRT=="4")
mean(BWP_4$bugs.rem)
#2.25

BWP_3 <- BWP %>% filter(Temp.TRT=="3")
mean(BWP_3$bugs.rem)
#3.375

BWP_2 <- BWP %>% filter(Temp.TRT=="2")
mean(BWP_2$bugs.rem)
#5.5

BWP_1 <- BWP %>% filter(Temp.TRT=="1")
mean(BWP_1$bugs.rem)
#6.875

BWP_0 <- BWP %>% filter(Temp.TRT=="0")
mean(BWP_0$bugs.rem)
#7.375

```


```{r}

summSE.BWP<-summarySE(BWP,measurevar="BWP",groupvars=c("Temp.TRT", "Leaf.spp"),na.rm=TRUE)
summSE.BWP2<-summarySE(BWP,measurevar="prop.BWP",groupvars=c("Temp.TRT", "Leaf.spp"),na.rm=TRUE)

```


#Binomial regression analysis!
```{r}

bin.dev<-glm(cbind(BWP,no.BWP)~Temp.TRT*Leaf.spp, data=BWP, family=binomial)
summary(bin.dev)

bin.dev.noleaf <- glm(cbind(BWP,no.BWP)~Temp.TRT, data=BWP, family=binomial)
summary(bin.dev.noleaf)


```


#adding line to dev graph
```{r}

dummy.data<-data.frame(Temp.TRT=seq(0,4.4,by=0.1))
dummy.data$fit<-predict.glm(bin.dev.noleaf,newdata=dummy.data,type="response")

```


```{r}

plot.BWP <- ggplot()+
  theme_classic()+
  geom_bar(data=summSE.BWP2, aes(x=Temp.TRT, y=prop.BWP, group=Leaf.spp, color=Leaf.spp, fill = Leaf.spp),
           width = 0.4, position = position_dodge(width=0.5), stat="identity")+  
  theme(legend.position="right", legend.title = element_blank())+
  xlab("Temperature treatment")+
  ylab("Proportion of insects with black wingpads")+
  geom_errorbar(data=summSE.BWP2, aes(x=Temp.TRT, y= prop.BWP, ymin=prop.BWP-se, ymax=prop.BWP+se, group=Leaf.spp),
                width=.2, position=position_dodge(width=0.5), color= "black")+
  geom_line(data=dummy.data,aes(x=Temp.TRT,y=fit), linetype="longdash")+
  theme(legend.text=element_text(size=14))+
  theme(axis.title=element_text(size=14))+
  theme(axis.text=element_text(size=12, face="bold"))+
  scale_x_continuous(breaks=0:4,labels=c("+0°C","+1°C","+2°C","+3°C","+4°C"))+
  scale_color_manual(values=c("black","black"), guide="none")+
  scale_fill_manual(values=c("#F7E225FF", "#3F4788FF"),
                     labels=c(expression(paste(italic("Acer"))),expression(paste(italic("Rhododendron")))))+
  theme(legend.text.align=0)
  

plot.BWP

```

```{r}

jpeg(filename="barplot.dev.jpeg", width=20, height=12, units="cm", pointsize=12, bg="white", res=600)
plot.BWP
dev.off()

```


