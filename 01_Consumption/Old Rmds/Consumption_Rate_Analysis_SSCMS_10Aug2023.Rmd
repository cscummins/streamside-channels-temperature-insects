---
title: "Consumption_Rate_Calculations_SSCMS_10Aug2023"
author: "Carolyn Cummins"
date: "2023-08-10"
output: html_document
---

Set WD and read in packages:
```{r}

setwd("/Users/ccummins/Documents/Dissertation etc./Data/Streamside channels/01_Consumption")

library(Rmisc)
library(lme4)
library(lmerTest)
library(ggplot2)
library(scales)
library(tidyverse)

```

Read in consumption rate data
```{r}

CT1 <- read.csv("Consumption_data_CT1_28April21.csv", header=T)
CT1 <- CT1 %>% mutate(date.start=ymd(date.start))
CT1 <- CT1 %>% mutate(date.end=ymd(date.end))

CT2 <- read.csv("Consumption_data_CT2_19May21.csv", header=T)
CT2 <- CT2 %>% filter(!row_number() %in% c(161:248))
CT2 <- CT2 %>% mutate(date.start=dmy(date.start))
CT2 <- CT2 %>% mutate(date.end=dmy(date.end))

CT3 <- read.csv("Consumption_data_CT3_19May21.csv", header=T)
CT3 <- CT3 %>% filter(!row_number() %in% c(161:248))
CT3 <- CT3 %>% mutate(date.start=dmy(date.start))
CT3 <- CT3 %>% mutate(date.end=dmy(date.end))

all_consumption <- read.csv("Consumption_data_all_11Dec2019.csv")
all_consumption <- all_consumption %>% filter(!row_number() %in% c(569:2790))

#will now bind CT1, CT2, and CT3. These have been determined to be identical to the all_consumption data
all_consumption_data <- bind_rows(CT1,CT2,CT3)
all_consumption_data <- all_consumption_data %>% dplyr::rename(trial = trial.)
all_consumption_data <- all_consumption_data %>% dplyr::select(-c(notes))

```

Create blotted:AFDM regression!
```{r}

blot_AFDM_data <- read.csv("Blot_AFDM_reg_29Apr21.csv", header = TRUE)
blot_AFDM_data$blotted_g <- (blot_AFDM_data$boat_blotted_g-blot_AFDM_data$boat_g)
blot_AFDM_data$AFDM_g <- (blot_AFDM_data$tin_DM_g - blot_AFDM_data$tin_ash_g)

blot_AFDM_data_R <- blot_AFDM_data[which(blot_AFDM_data$R.A=="R"),]
blot_AFDM_data_A <- blot_AFDM_data[which(blot_AFDM_data$R.A=="A"),]
blot_AFDM_data_A <- blot_AFDM_data_A[which(blot_AFDM_data_A$blotted_g>0),] #removed one outlier where the blotted weight was negative because this doesn't make sense and was likely a data entry/recording error

#for this regression, force it through the origin.
blot_AFDM_reg_R <- lm(AFDM_g~0+blotted_g, data = blot_AFDM_data_R)
summary(blot_AFDM_reg_R)
#R AFDM = 0.399453(blotted)

blot_AFDM_reg_A <- lm(AFDM_g~0+blotted_g, data = blot_AFDM_data_A)
summary(blot_AFDM_reg_A)
#A AFDM = 0.209441(blotted)

plot_blot_AFDM_R <-ggplot(blot_AFDM_data_R,aes(x=AFDM_g,y=blotted_g))+theme_classic()+
  geom_point()

plot_blot_AFDM_A <-ggplot(blot_AFDM_data_A,aes(x=AFDM_g,y=blotted_g))+theme_classic()+
  geom_point()

```


*Data carpentry to get consumption rates*


```{r}

#Get blotted weights
all_consumption_data <- all_consumption_data %>% mutate(blotted_g = boat.blot.g - boat.g)

all_consumption_data <- na.omit(all_consumption_data) #deleted rows with NA for now

#Get post-consumption AFDM
all_consumption_data <- all_consumption_data %>% filter(blotted_g>0) #omit one observation where blotted weight was negative
all_consumption_data <- all_consumption_data %>% mutate(DM_fp = fp.PCLDM.g-fp.g)
all_consumption_data <- all_consumption_data %>% mutate(DM_tin = tin.dm.g - tin.mass.g) #these seem systematically lower than the FP ones
all_consumption_data <- all_consumption_data %>% mutate(AFDM_end = tin.dm.g-tin.ash.g)

```


Get beginning AFDM based on leaf species-specific blotted:AFDM regressions
R AFDM = 0.399453(blotted)
A AFDM = 0.209441(blotted)
```{r}
all_consumption_data <- all_consumption_data %>% mutate(
  AFDM_beg = case_when(
    species=="A" ~ 0.209441*blotted_g,
    species=="R" ~ 0.399453*blotted_g
  )
)

all_consumption_data <- all_consumption_data %>% mutate(AFDM_beg_mg = AFDM_beg*1000)
all_consumption_data <- all_consumption_data %>% mutate(AFDM_end_mg = AFDM_end*1000)

```


In this chunk:
1. Calculate consumption rates
2. Separate microbes and bugs
3. Get average microbial consumption rate by trial, temperature, and leaf species
4. Bind the microbe consumption averages to the bug data based on trial, temp, and leaf species
5. Subtract microbe consumption averages from bug consumption rates
6. Create new dataframe with average consumption rates 
```{r}

all_consumption_data <- all_consumption_data %>% mutate(consumption.rate.mg.day = ((AFDM_beg_mg-AFDM_end_mg)/days))
consumption_microbes <- all_consumption_data %>% filter(type=="microbes")
consumption_bugs <- all_consumption_data %>% filter(type=="bug")

microbial_consumption_averages <- consumption_microbes %>%
  group_by(trial, treatment, species) %>%
  dplyr::summarise(mean_microbe_consumption = mean(consumption.rate.mg.day, na.rm = T)) %>% ungroup()

consumption_bugs_microbes <- left_join(consumption_bugs, microbial_consumption_averages)
consumption_bugs_microbes <- consumption_bugs_microbes %>% mutate(consumption_bug_mg_day.corr=consumption.rate.mg.day-mean_microbe_consumption)

average_bug_consumption_bychannel.sp <- consumption_bugs_microbes %>% 
  group_by(trial, date.start, date.end, treatment, channel, species) %>% 
  dplyr::summarise(mean_consumption_mg.day = mean(consumption_bug_mg_day.corr), 
            sd_consumption = sd(consumption_bug_mg_day.corr),
            n.consumption = n()) %>% 
  mutate(se_consumption = sd_consumption / sqrt(n.consumption),
         lower_ci_consumption = mean_consumption_mg.day - qt(1-(0.05/2), n.consumption - 1)*se_consumption,
         upper_ci_consumption = mean_consumption_mg.day + qt(1-(0.05/2), n.consumption-1)*se_consumption)

average_bug_consumption_bychannel.sp <- average_bug_consumption_bychannel.sp %>% arrange(desc(channel), desc(trial))

```


Read in the temperature data averaged at the flume level, bind with the consumption_bugs_microbes dataframe
```{r}

channel_temp_weekly_averages_1 <- read.csv("all_flume_temp_expt_averages_1.csv")
channel_temp_weekly_averages_1$week <- as.character(channel_temp_weekly_averages_1$week)
channel_temp_weekly_averages_2 <- read.csv("all_flume_temp_expt_averages_2.csv")
channel_temp_weekly_averages_2 <- channel_temp_weekly_averages_2 %>% filter(week %in% c("1b","3b"))
channel_temp_weekly_averages_3 <- read.csv("all_flume_temp_expt_averages_3.csv")
channel_temp_weekly_averages_3 <- channel_temp_weekly_averages_3 %>% filter(week %in% c("1c","3c"))

channel_temp_weekly_averages <- bind_rows(channel_temp_weekly_averages_1,channel_temp_weekly_averages_2, channel_temp_weekly_averages_3)


consumption_bugs_microbes <- consumption_bugs_microbes %>% mutate(
  week = case_when(
    date.start=='2019-03-12' & date.end=='2019-03-20' ~ '1',
    date.start=='2019-03-12' & date.end=='2019-03-21' ~ '1b',
    date.start=='2019-03-13' & date.end=='2019-03-21' ~ '1c',
    date.start=='2019-03-27' & date.end=='2019-04-03' ~ '3',
    date.start=='2019-03-28' & date.end=='2019-04-03' ~ '3b',
    date.start=='2019-03-28' & date.end=='2019-04-04' ~ '3c',
    date.start=='2019-04-10' & date.end=='2019-04-17' ~ '5',
      )
)

consumption_rate_weekly_temps <- left_join(consumption_bugs_microbes, channel_temp_weekly_averages)

```

Model!

```{r}
pal.consumption <- c("#FEB72DFF", "#3F4788FF")
consumption_rate_weekly_temps$species = as.factor(consumption_rate_weekly_temps$species)

lmer_indiv_consumption <- lmer(consumption_bug_mg_day.corr~mean_temp_C*species + (1|channel), data=consumption_rate_weekly_temps)
summary(lmer_indiv_consumption)

```


```{r}
                               
consumption_temp_plot <- ggplot(consumption_rate_weekly_temps, aes(x=mean_temp_C, y=consumption_bug_mg_day.corr, color=species))+
  geom_point(aes(shape=trial))+
  geom_smooth(method="lm", color="gray13", aes(linetype=species))+
  geom_point(aes(shape=as.factor(trial)))+
  theme_classic()+
  theme(legend.title=element_blank())+
  xlab("Mean temperature (°C)")+
  ylab(expression("Consumption rate (mg/d"^-1*")"))+
  theme(legend.text=element_text(size=14))+
  theme(axis.title=element_text(size=14))+
  theme(axis.text=element_text(size=12, face="bold"))+
  scale_color_manual(values = pal.consumption, labels=c(expression(paste(italic("Acer"))), expression(paste(italic("Rhododendron")))))+
  scale_linetype_manual(values = c("dotted", "solid"),
  labels=c(expression(paste(italic("Acer"))), expression(paste(italic("Rhododendron")))))+
  theme(legend.text.align=0)

consumption_temp_plot

```

Try making the plot with ggpredict so we can see accurate confidence intervals by leaf species
```{r}

library(ggsci)
library(ggeffects)

```


Split consumption rate data into R and A, model R as a function of temperature
```{r}

consumption_rate_weekly_temps_R <- consumption_rate_weekly_temps %>% filter(species=="R")
consumption_rate_weekly_temps_A <- consumption_rate_weekly_temps %>% filter(species=="A")


rhodo_consumption_model <- lmer(consumption_bug_mg_day.corr ~ mean_temp_C + (1|channel),
                    data=consumption_rate_weekly_temps_R)

confint(rhodo_consumption_model, level=0.95)

pred.rhodo.consumption <- ggpredict(rhodo_consumption_model, terms="mean_temp_C")

summary(rhodo_consumption_model)

```


Model A as a function of temperature
```{r}

acer_consumption_model <- lmer(consumption_bug_mg_day.corr ~ mean_temp_C + (1|channel),
                    data=consumption_rate_weekly_temps_A)

confint(acer_consumption_model, level=0.95)

pred.acer.consumption <- ggpredict(acer_consumption_model, terms="mean_temp_C")

summary(acer_consumption_model)

```



```{r}
pred.rhodo.consumption$species <- "R"
pred.acer.consumption$species <- "A"
pred.r.a.consumption <- rbind(pred.rhodo.consumption, pred.acer.consumption)

```


```{r}

consumption_temp_plot_ggpredict <- ggplot(pred.r.a.consumption)+
  geom_line(aes(x=x, y=predicted, linetype=species))+
  geom_ribbon(aes(x = x, ymin = conf.low, ymax = conf.high, linetype=species), alpha = 0.25)+
  geom_point(data=consumption_rate_weekly_temps, 
             aes(x=mean_temp_C, y = consumption_bug_mg_day.corr, color=species, shape=as.factor(trial)))+
  theme_classic()+
  theme(legend.title=element_blank())+
  xlab("Mean temperature (°C)")+
  ylab(expression("Consumption rate (mg d"^-1*")"))+
  theme(legend.text=element_text(size=14))+
  theme(axis.title=element_text(size=14))+
  theme(axis.text=element_text(size=12, face="bold"))+
  scale_color_manual(values = pal.consumption, 
                     labels=c(expression(paste(italic("Acer"))), expression(paste(italic("Rhododendron")))))+
  scale_linetype_manual(values = c("dotted", "solid"),
  labels=c(expression(paste(italic("Acer"))), expression(paste(italic("Rhododendron")))))+
  theme(legend.text.align=0)+
  scale_shape_manual(values=c(16,17,15), labels=c("Trial 1", "Trial 2", "Trial 3"))+
  scale_x_continuous(breaks=c(9,10,11,12,13,14,15,16,17,18))

consumption_temp_plot_ggpredict

```

```{r}
#jpeg(filename="consumption_temp_plot.jpeg", width=17, height=12, units="cm", pointsize=12, bg="white", res=600)
#consumption_temp_plot_ggpredict
#dev.off()
```

Correct consumption rates by average body mass during trial
1.) Read in data with beginning and ending masses for each bug
```{r}

bug.masses <- read.csv("bug.lengths.masses.SSC2019.csv")
colnames(bug.masses)[colnames(bug.masses)=="Temp.TRT"]<-"treatment"
colnames(bug.masses)[colnames(bug.masses)=="Channel"]<-"channel"
colnames(bug.masses)[colnames(bug.masses)=="Leaf.spp."]<-"species"
colnames(bug.masses)[colnames(bug.masses)=="Chamber"]<-"chamber"
colnames(bug.masses)[colnames(bug.masses)=="Beg.Length.mm"]<-"beg.length.mm"
colnames(bug.masses)[colnames(bug.masses)=="End.Length.mm"]<-"end.length.mm"

bug.masses <- bug.masses %>% select(chamber, beg.length.mm, beg.mass.mg, end.length.mm, end.mass.mg, igr, igr_norm)
#lots of missing data for bugs in consumption trials that died, so we don't have their ending mass or igr...

```


Instead of normalizing consumption by the mass during the trial, just use beginning mass to normalize all the consumption rates?
```{r}

photos.beg.all<-read.csv("SSC2019.photos.beg.csv")
colnames(photos.beg.all)[colnames(photos.beg.all)=="Temp.TRT"]<-"treatment"
colnames(photos.beg.all)[colnames(photos.beg.all)=="Channel"]<-"channel"
colnames(photos.beg.all)[colnames(photos.beg.all)=="Leaf.spp."]<-"species"
colnames(photos.beg.all)[colnames(photos.beg.all)=="Chamber"]<-"chamber"
colnames(photos.beg.all)[colnames(photos.beg.all)=="Beg.Length.mm"]<-"beg.length.mm"

beg.lengths.all <-photos.beg.all %>% select(treatment, channel, species, chamber, beg.length.mm)
consumption.rate.weekly.temps.l.m <- left_join(consumption_rate_weekly_temps, beg.lengths.all)

consumption.rate.weekly.temps.l.m <- consumption.rate.weekly.temps.l.m %>% mutate(beg.mass.mg=(beg.length.mm^2.737)*(0.0170))

```




